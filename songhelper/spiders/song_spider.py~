# Basic song finder

from scrapy import log
from scrapy.http import Request
from scrapy.contrib.spiders import CrawlSpider
from scrapy.selector import Selector
#from songhelper.items import SongItem

class SongSpider(CrawlSpider):
    name = 'songhelper'

    def __init__(self, artist=None, *args, **kwargs):
        super(SongSpider, self).__init__(*args, **kwargs)
        self.start_urls = [
            'http://www.last.fm/search?q=%s' % artist
            ]

    def parse_start_url(self, response):
        home = 'http://www.last.fm'
        sel = Selector(response)

        # choose first link (top result)
        try:
            artist_link = str(home + sel.xpath('//h3/a/@href').extract()[0])
        except IndexError:
            self.log('Could not match any items.',
                     level=log.ERROR)
            return
        
        artist_name = str(sel.xpath('//h3/a/text()').extract()[0])

        if ' - ' in artist_name:
            self.log('Found song: ' + artist_name,
                     level=log.INFO)
            return
        else:
            self.log('Found artist: ' + artist_name,
                     level=log.INFO)
            return Request(url=artist_link,
                           callback=self.get_songs)
            
    def get_songs(self, response):
        self.log('Getting songs...', level=log.INFO)
        return
        
